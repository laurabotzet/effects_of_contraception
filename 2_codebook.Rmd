---
title: "Codebook Effects of Contraception"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    code_folding: 'hide'
    self_contained: false
---
  
```{r results='hide',message=F,warning=F}
source("0_helpers.R")
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
pander::panderOptions("table.split.table", Inf)
pander::panderOptions('round',2)
pander::panderOptions('digits',2)
pander::panderOptions('keep.trailing.zeros',TRUE)

load("data/cleaned_selected.rdata")

knitr::opts_chunk$set(echo = FALSE, error = TRUE, dev = "CairoPNG")
library(ggplot2)
theme_set(theme_bw())

library(codebook)
```

## Included variables for codebook
```{r}
data = all_surveys %>%
  select(session,
         age,
         education_years,
         net_income,
         bfi_agree,
         bfi_consc,
         bfi_open,
         bfi_extra,
         bfi_neuro,
         religiosity,
         pregnant_stress,
         duration_relationship_years,
         duration_relationship_month,
         days_with_partner,
         nights_with_partner,
         soi_r_attitude,
         soi_r_behavior,
         soi_r_desire,
         number_sexual_partner,
         contraception_method,
         contraception_approach,
         contraception_method_broad,
         contraception_meeting_partner,
         partner_attractiveness_face,
         partner_attractiveness_body,
         relationship_satisfaction_overall,
         relationship_satisfaction_2,
         relationship_satisfaction_3,
         relationship_problems_R,
         relationship_conflict_R,
         satisfaction_sexual_intercourse,
         reasons_for_exclusion,
         pregnant_trying)

# based on diary:
data_diary = diary %>%
  select(high_libido,
         sex_active, sex_activity_anal_sex, sex_activity_bdsm_dom, sex_activity_bdsm_sub,
         sex_activity_cuddling, sex_activity_cunnilingus, sex_activity_cybersex, sex_activity_dirty_talk,
         sex_activity_fellatio, sex_activity_kissing,  sex_activity_masturbated_by_partner,
         sex_activity_masturbated_partner, sex_activity_masturbation, sex_activity_other,
         sex_activity_phone_skype_sex, sex_activity_pornography, sex_activity_sex, sex_activity_touch_other, 
         sex_activity_toys, sex_activity_unclear,  sex_other, sex_solo, sex_unclear,
         days_done)
```


```{r}
attributes(s3_daily$grooming_broad)$scale_item_names <- NULL
s3_daily <- s3_daily %>% filter(!is.na(session), !is.na(created))
s3_daily <- s3_daily %>% select(-!!names(lab))
s3_daily <- s3_daily %>% ungroup()

library(future)
if (file.exists("reliabilities_new.rdata")) {
  load("reliabilities_new.rdata")
  } else {
    library(future.batchtools)
  # plan(tweak(multicore, workers = 3))
  # login <- tweak(remote, workers = "arslan@arc-srv-cpt7.mpib-berlin.mpg.de") # Your username goes before the @
  # plan(login) # this tells the future package that we want to use a remote server for running our future operations
  
  login <- tweak(remote, workers = "arslan@tardis.mpib-berlin.mpg.de")
  qsub <- tweak(batchtools_torque, template = 'torque-lido.tmpl', 
              # workers = "export LSF_ENVDIR=/opt/lsf/conf",
                  resources = list(job.name = 'multilevel_reliability',
                                  queue = 'default',
                                  walltime = "5:0:0",
                                  memory = 32, #gb
                                  ncpus = 1))
  ## Specify future topology
  ## login node -> { cluster node (compile brms model) } -> { run chains on multiple cores }
  plan(list(
    login,
    qsub
  ))
  
  reliabilities_diary = future::value(future({
      codebook::compute_reliabilities(s3_daily, 'repeated_many')
  }))
  save(reliabilities_diary, file = "reliabilities_new.rdata")
}

plan(multicore)
```

## Demographics

Participants filled out these surveys before being invited to the daily diary. After finishing them, they were invited to fill out the diary on the next day.

```{r pre_survey, results='asis'}
codebook(s1_demo,  missingness_report = FALSE, indent = "##")
```

## Personality
```{r initial}
codebook(s2_initial, missingness_report = FALSE, indent = "##")
```

## Diary
Participants received invitations to fill out the diary daily over a period of 70 days.

```{r diary}
codebook(s3_daily, reliabilities_diary, missingness_report = FALSE, indent = "##")
```

## Time spent

Single participants answered questions about who they spent time with and/or thought about during the diary. We asked them questions about commonly mentioned names after the end of the diary.

```{r time_spent}
codebook(s4_timespent, indent = "##")
```

## Follow-up survey

At the end of the diary, participants were debriefed and answered these follow-up questions.

```{r follow_up}
codebook(s4_followup, indent = "##")
```

## Menstruation follow-up

To be able to backward-count from the onset of the next menstruation, we followed up with women who had not menstruated in the last 5 days of the diary, until the next menstrual onset for up to 40 days.

```{r menstruation_follow_up}
codebook(s5_hadmenstruation, indent = "##")
```


## Lab Study

A subset of the diary participants also participated in a lab study, in which hormones where collected. Participation dates were intended to overlap, but scheduling did not always permit this.

```{r lab}
codebook(lab, indent = "##")
```

