---
title: "Analyses Effects of Contraception"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    code_folding: 'hide'
    self_contained: false
---
  
```{r results='hide',message=F,warning=F}
source("0_helpers.R")

load("data/cleaned_selected.rdata")

knitr::opts_chunk$set(echo = FALSE, error = TRUE, dev = "CairoPNG")
library(ggplot2)
theme_set(theme_bw())
```


## Included variables for codebook
```{r}
data = all_surveys %>%
  select(session,
         age,
         education_years,
         net_income,
         starts_with("bfi_agree"),
         starts_with("bfi_consc"),
         starts_with("bfi_open"),
         starts_with("bfi_extra"),
         starts_with("bfi_neuro"),
         religiosity,
         pregnant_stress,
         duration_relationship_years,
         duration_relationship_month,
         days_with_partner,
         nights_with_partner,
         starts_with("soi_r"),
         soi_r_behavior,
         soi_r_desire,
         number_sexual_partner,
         contraception_method,
         contraception_approach,
         contraception_method_broad,
         contraception_meeting_partner,
         partner_attractiveness_face,
         partner_attractiveness_body,
         relationship_satisfaction_overall,
         relationship_satisfaction_2,
         relationship_satisfaction_3,
         relationship_problems_R,
         relationship_conflict_R,
         satisfaction_sexual_intercourse,
         reasons_for_exclusion,
         pregnant_trying)

# based on diary:
data_diary = diary %>%
  select(session,
         high_libido,
         sex_active, sex_activity_anal_sex, sex_activity_bdsm_dom, sex_activity_bdsm_sub,
         sex_activity_cuddling, sex_activity_cunnilingus, sex_activity_cybersex, sex_activity_dirty_talk,
         sex_activity_fellatio, sex_activity_kissing,  sex_activity_masturbated_by_partner,
         sex_activity_masturbated_partner, sex_activity_masturbation, sex_activity_other,
         sex_activity_phone_skype_sex, sex_activity_pornography, sex_activity_sex, sex_activity_touch_other, 
         sex_activity_toys, sex_activity_unclear,  sex_other, sex_solo, sex_unclear,
         days_done)
```


## Exclusion
For now based on old exclusion criteria --> update later
```{r}
n_excluded = data %>% filter(reasons_for_exclusion != "") %>% nrow()
data = data %>% filter(reasons_for_exclusion == "")
```
`r n_excluded` people were excluded.

## Wrangle data
created contraception_approach
```{r}
data = data %>% mutate(
    contraception_method = if_else(is.na(contraception_method), "", as.character(contraception_method)),
    com = contraception_method,
    contraception_approach = if_else(
        condition = com %contains% "hormonal_pill" | com %contains% "hormonal_other", # condition
        # true
        true = if_else(
            condition = com == "hormonal_pill" | com == "hormonal_other" | com == "hormonal_morning_after_pill", # condition
            true = if_else(com == "hormonal_pill", 
                                            true = "hormonal_pill_only", 
                                            false = "hormonal_other_only"
            ),
                                            false = "hormonal+barrier"
            ),
        if_else(
            condition = ! com %contains% "awareness", 
            true = if_else(condition = com != "",
                true = if_else(condition = com %contains% "barrier_intrauterine_pessar", 
                               true = "barrier_pessar",
                                if_else(condition = com %contains% "barrier_condoms", true = "condoms", false = "other")),
                false = "nothing"),
                false = "awareness")
        )
          # false
    )
data$contraception_approach = factor( all_surveys$contraception_approach, levels = c("condoms", "barrier_pessar", "hormonal+barrier", "hormonal_pill_only", "hormonal_other_only", "awareness", "nothing", "other") )
qplot(data$contraception_approach) + coord_flip()
```

create current contraceptive status (hormonal vs. non hormonal)
```{r}
data = data %>% mutate(
  contraception_hormonal = factor(ifelse(contraception_approach %contains% "hormonal", "yes", "no")))
qplot(data$contraception_hormonal) + coord_flip()
```

create variable to indicate whether people changed contraception since meeting their partner
```{r}
crosstabs(~contraception_hormonal + contraception_meeting_partner, data = data)
data = data %>% mutate(
  contraception_change_since_meeting_partner = ifelse(
    contraception_hormonal == "yes" & contraception_meeting_partner == 1, "congruent_hormonal",
    ifelse(
      contraception_hormonal == "no" & contraception_meeting_partner == 0, "congruent_nonhormonal",
      ifelse(
        contraception_hormonal == "yes" & contraception_meeting_partner == 0, "switched_to_hormonal",
        ifelse(
          contraception_hormonal == "no" & contraception_meeting_partner == 1, "switched_to_nonhormonal",
          NA)))))
qplot(data$contraception_change_since_meeting_partner) + coord_flip()
```

calculate mean of libido, sex_active_frequency and actual sex frequency based on diary
```{r}
data_diary_means = data_diary %>%
  mutate(days_done = as.numeric(days_done)) %>%
  #restrict analyses to people who filled out more than 30 days
  filter(days_done > 30) %>% 
  group_by(session) %>%
  summarise(diary_libido_mean = mean(high_libido, na.rm = T),
            diary_sex_active_mean = mean(sex_active, na.rm = T),
            diary_sex_active_sex_mean = mean(sex_activity_sex, na.rm = T))

qplot(data_diary_means$diary_libido_mean)
qplot(data_diary_means$diary_sex_active_mean)
qplot(data_diary_means$diary_sex_active_sex_mean)

data = left_join(data, data_diary_means, by = "session")
```

relationship status (single vs partnered)
```{r}
data = data %>% mutate(
  relationship_status = ifelse(is.na(duration_relationship_month), "Single", "Partnered")
)

qplot(data$relationship_status)
```


## standardize
```{r}
data = data %>%
  mutate(relationship_satisfaction_overall_z = scale(relationship_satisfaction_overall,
                                                     center = TRUE, scale = TRUE))
```

## First Models relationship satisfaction overall

```{r}
m1 = brm(relationship_satisfaction_overall_z ~ contraception_hormonal + contraception_meeting_partner +
    contraception_hormonal : contraception_meeting_partner +
    age + education_years + net_income + bfi_open + bfi_consc + bfi_extra +
    bfi_agree + bfi_neuro + religiosity + pregnant_stress +
    duration_relationship_years + days_with_partner + 
    nights_with_partner + soi_r_behavior + soi_r_attitude +
    soi_r_desire + number_sexual_partner,
    data = data, family = gaussian())

summary(m1)

m1_unadj = brm(file = "models/m1_relsat_unadj", # cache model. have to manually delete when data/model changes
  relationship_satisfaction_overall_z ~ contraception_hormonal + contraception_meeting_partner +
           contraception_hormonal : contraception_meeting_partner,
         data = data, family = gaussian(), cores = 4) %>% 
  add_criterion("loo") %>% 
  add_criterion("R2")
summary(m1_unadj)
# plot(m1_unadj)

library(loo)
compare_models <- loo(m1, m1_unadj) # Fehlermeldung wegen haven_labelled
loo(m1)
print(loo_compare(m1_unadj, m1), simplify = F)

library(sjPl)
sjPlot::tab_model(m1_unadj, show.hdi50 = FALSE, bpe = "mean",ci.hyphen = ";", prefix.labels = "label")

library(bayestestR)
equiv_test <- equivalence_test(m1_unadj, range = c(-0.1, 0.1))
equiv_test

sjstats::equi_test(m1, out = "plot")

equiv_test <- equivalence_test(m1, range = c(-0.1, 0.1))
equiv_test

library(margins)
marginal_effects(m1_unadj) # no valid term

library(brms)
marginal_smooths(m1_unadj) # no valid term
```


```{r}
m3 = brm(diary_libido_mean ~ contraception_hormonal + contraception_meeting_partner +
           contraception_hormonal : contraception_meeting_partner,
    data = data, family = gaussian(), cores = 4)

m4 = brm(diary_libido_mean ~ contraception_hormonal + contraception_meeting_partner +
           contraception_hormonal : contraception_meeting_partner +
 
             age + education_years + net_income + bfi_open + bfi_consc + bfi_extra + bfi_agree + bfi_neuro + religiosity + pregnant_stress +
    duration_relationship_years + days_with_partner + 
    nights_with_partner + soi_r_behavior + soi_r_attitude +
    soi_r_desire + number_sexual_partner,
    data = data, family = gaussian(), cores = 4)

```


```{r}
qplot(log(15/30/12 + all_surveys$duration_relationship_month / 12 + all_surveys$duration_relationship_years))
qplot(all_surveys$number_sexual_partner, bins = 50) + scale_x_continuous(trans = "log1p", breaks = c(0,1,2,5,10,50,100))
qplot(residuals(lm(all_surveys$number_sexual_partner ~ all_surveys$age)), bins = 50) +xlim(-20,20)
+ scale_x_continuous(trans = "log1p", breaks = c(0,1,2,5,10,50,100))

qplot(all_surveys$number_sexual_partner / (all_surveys$age - mean(all_surveys$first_time, na.rm = T)), bins = 50)
+xlim(-20,20)

library(tidyverse)
all_surveys %>% filter(number_sexual_partner > 50) %>% select(number_sexual_partner, age, first_time, number_sexual_partner_certainty, reasons_for_exclusion, free_not_covered_demo) %>% arrange(number_sexual_partner)
```

